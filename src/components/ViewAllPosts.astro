---
import { db } from '../../lib/db'; // MySQL2 pool connection (see note below)
const [rows] = await db.query('SELECT * FROM posts ORDER BY createdAt DESC');
---

<div class="page-container">
  <h2>Blog Posts</h2>
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Is Private</th>
        <th>Edit</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {rows.map(post => (
        <tr>
          <td>
            <a href={`/post/${post.id}`} class="title-link">{post.title}</a>
          </td>
          <td style="text-align:center">
            <input 
              type="checkbox" 
              checked={post.isPrivate} 
              onChange={`togglePrivacy(${post.id})`} 
            />
          </td>
          <td style="text-align:center">
            <a href={`/create-a-post?id=${post.id}`} class="edit-button">Edit</a>
          </td>
          <td style="text-align:center">
            <button onclick={`deletePost(${post.id})`} class="delete-button">X</button>
          </td>
        </tr>
      ))}
    </tbody>
  </table>

  <script type="module" client:load>
    async function deletePost(id) {
      if (!confirm("Delete this post?")) return;
      const res = await fetch(`/api/delete-post?id=${id}`, { method: 'DELETE' });
      if (res.ok) location.reload();
      else alert("Failed to delete.");
    }

    async function togglePrivacy(id) {
      const res = await fetch(`/api/update-privacy?id=${id}`, { method: 'PATCH' });
      if (res.ok) location.reload();
      else alert("Failed to toggle privacy.");
    }
  </script>
</div>

<style>
  .page-container {
    background-color: #2f4f4f;
    color: white;
    padding: 20px;
    font-family: Arial, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
  }

  table {
    width: 100%;
    background-color: darkslategray;
    border-collapse: collapse;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 8px;
  }

  th {
    text-align: left;
    color: white;
    background-color: darkslategray;
  }

  .title-link {
    color: white;
    text-decoration: none;
  }

  .title-link:hover {
    text-decoration: underline;
  }

  .edit-button {
    background-color: #4CAF50;
    color: white;
    padding: 5px 10px;
    border: none;
    text-decoration: none;
  }

  .delete-button {
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    padding: 5px 10px;
    cursor: pointer;
  }
</style>
